name: Deploy AI Capabilities WebApp

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t ai-capabilities-webapp:latest .
      
      - name: Test Docker image
        run: |
          docker run -d --name test-container -p 8000:8000 ai-capabilities-webapp:latest
          sleep 10
          curl -f http://localhost:8000/health || exit 1
          docker stop test-container
          docker rm test-container
      
      # Uncomment and configure the following steps for automatic deployment to your server
      # - name: Deploy to server
      #   env:
      #     SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      #     SERVER_HOST: ${{ secrets.SERVER_HOST }}
      #     SERVER_USER: ${{ secrets.SERVER_USER }}
      #   run: |
      #     mkdir -p ~/.ssh
      #     echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
      #     chmod 600 ~/.ssh/id_rsa
      #     ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
      #     
      #     # Copy files to server
      #     rsync -avz --delete \
      #       --exclude '.git' \
      #       --exclude '.github' \
      #       ./ $SERVER_USER@$SERVER_HOST:/opt/ai-capabilities-webapp/
      #     
      #     # Deploy on server
      #     ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
      #       cd /opt/ai-capabilities-webapp
      #       docker-compose down
      #       docker-compose build
      #       docker-compose up -d
      #     ENDSSH
